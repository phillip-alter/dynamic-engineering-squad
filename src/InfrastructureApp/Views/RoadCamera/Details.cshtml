@model InfrastructureApp.ViewModels.RoadCameraDetailsViewModel
<div class="container mt-4">
<h1 class="text-center mb-4">Camera Details</h1>

@if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
{
    <div class="alert alert-warning">
        @Model.ErrorMessage
    </div>
}

@if (Model.Camera == null)
{
    <p><em>Camera not available.</em></p>
    <a class="btn btn-secondary" asp-controller="RoadCamera" asp-action="Index">Back to cameras</a>
}
else
{
    var cam = Model.Camera;

    <div class="mb-3 text-center">
        <a class="btn btn-secondary" asp-controller="RoadCamera" asp-action="Index">Back to cameras</a>
    </div>

    <div class="card shadow-sm mx-auto" style="max-width: 950px;">
        <div class="card-body">
            <h3 class="mb-2">@cam.Name</h3>

            <div class="text-muted mb-3">
                <span><strong>ID:</strong> @cam.CameraId</span>
                <span class="mx-2">â€¢</span>
                <span><strong>Lat/Lng:</strong> @cam.Latitude, @cam.Longitude</span>
            </div>

            @{
                var img = string.IsNullOrWhiteSpace(cam.ImageUrl)
                    ? "https://via.placeholder.com/1280x720?text=No+Image"
                    : cam.ImageUrl;
            }

           <div class="text-center mb-3">
                <img id="cameraImage"
                    src="@img"
                    alt="Camera image"
                    class="img-fluid rounded shadow"
                    style="max-height: 650px;" />
            </div>


            <div class="small text-muted mb-3">
                Last updated:
                <span id="lastUpdatedText">
                    @(cam.LastUpdated != null ? cam.LastUpdated.Value.ToLocalTime().ToString("g") : "unknown")
                </span>
            </div>

            <div class="d-flex gap-2 flex-wrap justify-content-center">
                <button id="refreshBtn" class="btn btn-outline-primary">
                    Refresh
                </button>

                <a class="btn btn-outline-danger"
                   asp-controller="ReportIssue"
                   asp-action="Create"
                   asp-route-cameraId="@cam.CameraId"
                   asp-route-lat="@cam.Latitude"
                   asp-route-lng="@cam.Longitude"
                   asp-route-capturedAt="@(cam.LastUpdated?.ToString() ?? "")">
                    Report Issue From This Camera
                </a>
            </div>

            <div id="refreshStatus" class="small text-muted mt-2 text-center"></div>
        </div>
    </div>
    

    <script>
        (function () {
            const btn = document.getElementById("refreshBtn");
            const img = document.getElementById("cameraImage");
            const updated = document.getElementById("lastUpdatedText");
            const status = document.getElementById("refreshStatus");
            const cameraId = "@cam.CameraId";

            btn.addEventListener("click", async function () {
                status.textContent = "Refreshing...";

                try {
                    const res = await fetch(`/RoadCamera/RefreshImage?id=${encodeURIComponent(cameraId)}`);
                    const data = await res.json();

                    if (data.error) {
                        status.textContent = "Could not refresh right now.";
                        return;
                    }

                    // Cache-bust the image in the browser:
                    const url = (data.imageUrl || "");
                    img.src = url + (url.includes("?") ? "&" : "?") + "t=" + Date.now();

                    updated.textContent = data.lastUpdated ? data.lastUpdated : "unknown";
                    status.textContent = "Updated.";
                } catch (e) {
                    status.textContent = "Refresh failed.";
                }
            });
        })();
    </script>
}
</div>
